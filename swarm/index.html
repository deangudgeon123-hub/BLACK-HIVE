---
layout: default
title: Swarm Panel Sim | BLACK-HIVE
nav_label: Swarm Panel
body_class: swarm-sim
head_extra: |
  <link rel="stylesheet" href="{{ '/assets/css/sim.css' | relative_url }}">
---
<section class="page-section page-section--sim">
  <div class="sim-app" role="region" aria-label="Swarm panel simulation">
    <div class="wrap">
      <div class="card">
        <div class="hd">
          <div class="controls" style="gap:12px">
            <h1>SWARM <b>PANEL</b></h1>
            <select id="scenarioSelect" class="select" aria-label="Scenario">
              <option value="perimeter" selected>Scenario: Perimeter Sweep</option>
              <option value="incident">Scenario: Crowd Incident (assist)</option>
            </select>
          </div>
          <div class="controls">
            <input id="cmdInput" class="input" placeholder="Type a command… (/ to focus)" style="width:240px" />
            <button id="cmdSend" class="btn">Send</button>
            <span id="statusPill" class="status neutral">Grounded</span>
          </div>
        </div>
        <div class="bd">
          <div class="controls" style="margin-bottom:10px">
            <button id="launchButton" class="btn btn--primary" aria-label="Launch Fleet">Launch Fleet (L)</button>
            <button id="rtbButton" class="btn" aria-label="Return to Base">Return to Base (R)</button>
            <button id="resetButton" class="btn" aria-label="Reset Panel">Reset (X)</button>
          </div>

          <div class="map-wrap">
            <div class="legend" aria-hidden="true">
              <span><span class="dot c-patrol"></span>PATROL</span>
              <span><span class="dot c-rtb"></span>RTB</span>
              <span><span class="dot c-assist"></span>ASSIST</span>
              <span><span class="dot c-dist"></span>DISTRESS</span>
            </div>
            <canvas id="mapCanvas" role="img" aria-label="Swarm area map showing drones and alerts"></canvas>
          </div>

          <div class="hud">
            <div class="kv"><span class="k">Operator</span><span class="v">1</span></div>
            <div class="kv"><span class="k">Fleet</span><span class="v" id="fleetValue">10</span></div>
            <div class="kv"><span class="k">Active</span><span class="v" id="activeValue">0</span></div>
            <div class="kv"><span class="k">Time</span><span class="v" id="timeValue">0.0s</span></div>
            <div class="kv"><span class="k">Incidents</span><span class="v" id="incidentsValue">0</span></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h2><b>Fleet</b> & Alerts</h2>
            <p class="sub">Live status • Modes: GROUND / PATROL / ASSIST / DISTRESS / RTB / CHARGE</p>
          </div>
          <div class="controls"><button id="exportBtn" class="btn" aria-label="Export Alerts">Export Alerts</button></div>
        </div>
        <div class="bd">
          <div class="grid" id="fleetList"></div>
          <h2 style="margin:14px 0 8px"><b>Alerts</b></h2>
          <div class="feed" id="feedContainer" role="log" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>
</section>
<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ===== Helpers ===== */
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerpDt=(perSec,dt)=>1 - Math.pow(1-perSec,dt);
  let _actx; function ping(kind='assist'){ try{
    _actx=_actx||new (window.AudioContext||window.webkitAudioContext)();
    const ctx=_actx,o=ctx.createOscillator(),g=ctx.createGain();
    const cfg=(kind==='distress')?{f1:720,f2:540,d:.22}:(kind==='resolve')?{f1:520,f2:880,d:.18}:{f1:600,f2:680,d:.18};
    o.type='sine'; o.frequency.setValueAtTime(cfg.f1,ctx.currentTime);
    o.frequency.linearRampToValueAtTime(cfg.f2,ctx.currentTime+cfg.d*.7);
    g.gain.setValueAtTime(.0001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.08,ctx.currentTime+.02);
    g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+cfg.d);
    o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+cfg.d);
  }catch(e){} }

  /* ===== Config ===== */
  const CFG={
    COUNT:10,
    WORLD:{x0:-90,y0:-60,x1:90,y1:60},
    BASE:{x:-70,y:-45},
    RINGS:[30,40,50,60,70],
    SIM:{ speed:.85, drain:.02, recharge:.4, low:20, rtbLerp:.18, altRate:.5 },
    COL:{ drone:'#cc1e2c', bad:'#ff6b6b', map:'#0c1218', line:'#1b2633', pitch:'#0a1519', pitchLine:'#20313b', ring:'#17202a', base:'#13212d', baseLine:'#274057' }
  };

  /* ===== DOM ===== */
  const $=id=>document.getElementById(id);
  const el={
    map:$('mapCanvas'), fleetV:$('fleetValue'), activeV:$('activeValue'), timeV:$('timeValue'), incV:$('incidentsValue'),
    list:$('fleetList'), feed:$('feedContainer'), status:$('statusPill'),
    launch:$('launchButton'), rtb:$('rtbButton'), resetButton:$('resetButton'), scenario:$('scenarioSelect'),
    cmdIn:$('cmdInput'), cmdSend:$('cmdSend'), exportBtn:$('exportBtn')
  };
  const ctx=el.map.getContext('2d');

  /* ===== State ===== */
  const view={w:0,h:0,dpr:1};
  const app={
    drones:[], run:false, time:0, inc:0, last:0,
    scenario:'perimeter',
    pendingIncidentAt:null,        // schedule time to fire incident
    assistResolver:null,
    highlight:null, incidentId:null, helpers:[]
  };

  /* ===== Geometry ===== */
  const toScreen=(x,y)=>{ const {x0,y0,x1,y1}=CFG.WORLD; const nx=(x-x0)/(x1-x0), ny=(y-y0)/(y1-y0); return [nx*view.w, (1-ny)*view.h]; };

  /* ===== Canvas visuals ===== */
  function drawBg(){
    ctx.clearRect(0,0,view.w,view.h);

    const [x0,y0]=toScreen(CFG.WORLD.x0,CFG.WORLD.y0), [x1,y1]=toScreen(CFG.WORLD.x1,CFG.WORLD.y1);
    ctx.fillStyle=CFG.COL.map; ctx.fillRect(0,0,view.w,view.h);
    ctx.strokeStyle=CFG.COL.line; ctx.lineWidth=2; ctx.strokeRect(x0,y1,x1-x0,y0-y1);

    const [px0,py0]=toScreen(-45,-25), [px1,py1]=toScreen(45,25);
    ctx.fillStyle=CFG.COL.pitch; ctx.strokeStyle=CFG.COL.pitchLine;
    ctx.beginPath(); ctx.rect(px0,py1,px1-px0,py0-py1); ctx.fill(); ctx.stroke();

    for(const r of CFG.RINGS){
      ctx.strokeStyle=CFG.COL.ring; ctx.beginPath();
      for(let a=0;a<=Math.PI*2.01;a+=0.04){
        const [sx,sy]=toScreen(r*Math.cos(a), r*Math.sin(a));
        a?ctx.lineTo(sx,sy):ctx.moveTo(sx,sy);
      }
      ctx.stroke();
    }
  }
  function drawDrones(){
    for(const d of app.drones){
      const [sx,sy]=toScreen(d.x,d.y);
      let color = CFG.COL.drone;
      if(d.mode==='RTB') color = CFG.COL.bad;
      if(d.mode==='ASSIST') color = '#f05c7a';
      if(d.mode==='DISTRESS') color = '#c0cad5';

      // glow
      ctx.save();
      ctx.globalAlpha = d.mode==='GROUND'?0.10:0.22;
      ctx.shadowBlur = 16;
      ctx.shadowColor = color;
      ctx.fillStyle   = color;
      ctx.beginPath(); ctx.arc(sx,sy,10,0,Math.PI*2); ctx.fill();
      ctx.restore();

      // core
      ctx.fillStyle = color;
      ctx.beginPath(); ctx.arc(sx,sy,5.2,0,Math.PI*2); ctx.fill();

      // assist tether
      if(d.mode==='ASSIST' && app.incidentId){
        const trg=app.drones.find(x=>x.id===app.incidentId);
        if(trg){
          const [tx,ty]=toScreen(trg.x,trg.y);
          const g = ctx.createLinearGradient(sx,sy,tx,ty);
          g.addColorStop(0,'rgba(240,92,122,0.0)'); g.addColorStop(1,'rgba(240,92,122,0.9)');
          ctx.strokeStyle=g; ctx.lineWidth=1.25;
          ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(tx,ty); ctx.stroke();
        }
      }

      // spotlight
      if(app.highlight===d.id){ ctx.strokeStyle='#fff'; ctx.lineWidth=1; ctx.beginPath(); ctx.arc(sx,sy,13,0,Math.PI*2); ctx.stroke(); }
    }
  }
  function render(){ drawBg(); drawDrones(); }

  /* ===== Drone creation / formation ===== */
  function createDrone(i){
    const th=((i*137.508)%360)*(Math.PI/180), ring=CFG.RINGS[i%CFG.RINGS.length];
    return { id:`BH-${String(i+1).padStart(2,'0')}`, idx:i, ring, th, omega:0.35+0.05*(i%4),
             x:CFG.BASE.x + Math.cos(th)*3, y:CFG.BASE.y + Math.sin(th)*3,
             alt:0, altBase:12+(i%3)*3, mode:'GROUND', battery:100-i*3, link:'GOOD', blink:0 };
  }

  function startCleanSweep(){
    // Evenly re-space angles so it always starts clean
    const n=app.drones.length, step=(Math.PI*2)/n, base=0;
    app.drones.forEach((d,i)=>{
      d.mode = 'PATROL';
      d.ring = CFG.RINGS[i%CFG.RINGS.length];
      d.th   = base + i*step;
      d.x    = d.ring*Math.cos(d.th);
      d.y    = d.ring*Math.sin(d.th);
      d.alt  = d.altBase;
    });
  }

  function applyRingFormation(dt){
    const baseSpin=app.time*0.12;
    const groups=new Map();
    app.drones.forEach(d=>{
      if(d.mode==='PATROL'){ const k=Math.round(d.ring); (groups.get(k)||groups.set(k,[]).get(k)).push(d); }
    });
    groups.forEach(list=>{
      const n=list.length; if(n<=1) return;
      list.sort((a,b)=>a.idx-b.idx);
      const step=(Math.PI*2)/n;
      list.forEach((d,i)=>{
        const target=baseSpin+i*step;
        const diff=((target-d.th+Math.PI)%(Math.PI*2))-Math.PI;
        d.th+=diff*Math.min(1,1.8*dt);
        d.x=d.ring*Math.cos(d.th);
        d.y=d.ring*Math.sin(d.th);
      });
    });
  }

  /* ===== Modes / update ===== */
  function updateDrone(d,dt){
    // battery
    if(d.mode!=='GROUND' && d.mode!=='CHARGE'){
      d.battery = Math.max(0, d.battery - (CFG.SIM.drain + 0.002*d.idx)*dt*60);
    }

    // auto RTB on low batt
    if(d.mode==='PATROL' && d.battery<=CFG.SIM.low){
      d.mode='RTB'; logAlert('ok', `RTB • ${d.id} low battery (${d.battery.toFixed(0)}%)`);
    }

    if(d.mode==='PATROL'){ d.th += d.omega*dt*CFG.SIM.speed; d.alt=d.altBase; }

    else if(d.mode==='ASSIST'){
      const trg = app.drones.find(x=>x.id===d.assistTargetId);
      if(!trg){ d.mode='PATROL'; }
      else{
        const dx=trg.x-d.x, dy=trg.y-d.y, dist=Math.hypot(dx,dy), want=d.assistRadius||10;
        if(dist>want*1.15){
          const k=1 - Math.pow(1-.28, dt); d.x+=dx*k; d.y+=dy*k;
        }else if(dist<want*0.85){
          const k=1 - Math.pow(1-.35, dt); d.x-=dx*k; d.y-=dy*k;
        }
        if(trg.mode==='DISTRESS'){ d.mode='DISTRESS'; d.distressTarget=trg.id; }
      }
    }

    else if(d.mode==='DISTRESS'){
      const trg=app.drones.find(x=>x.id===d.distressTarget);
      if(!trg || trg.mode!=='DISTRESS'){
        d.mode='ASSIST';
        d.assistTargetId=app.incidentId;
        d.assistRadius=12;
      }else{
        const dx=trg.x-d.x, dy=trg.y-d.y, k=1 - Math.pow(1-.18, dt);
        d.x+=dx*k; d.y+=dy*k;
      }
    }

    else if(d.mode==='RTB'){
      const dx=CFG.BASE.x-d.x, dy=CFG.BASE.y-d.y;
      const dist=Math.hypot(dx,dy);
      if(dist<6){
        d.mode='GROUND'; d.battery = Math.min(100, d.battery + CFG.SIM.recharge*dt*60);
        if(d.battery>=99){ d.mode='CHARGE'; d.chargeTime=1.2; }
      }else{
        const k=1 - Math.pow(1-CFG.SIM.rtbLerp, dt);
        d.x+=dx*k; d.y+=dy*k;
      }
    }

    else if(d.mode==='CHARGE'){
      d.chargeTime -= dt;
      if(d.chargeTime<=0){
        d.mode='GROUND';
        d.battery = 100;
      }
    }

    if(d.mode==='GROUND' && app.run){
      d.launchCooldown = (d.launchCooldown||0) + dt;
      if(d.launchCooldown>=0.6){
        d.mode='PATROL';
        d.launchCooldown=0;
        const th=((Math.random()*360)|0)*(Math.PI/180);
        d.x=CFG.BASE.x + Math.cos(th)*12;
        d.y=CFG.BASE.y + Math.sin(th)*12;
      }
    }
  }

  function updateFleet(dt){
    app.drones.forEach(d=>updateDrone(d,dt));
    applyRingFormation(dt);
    app.drones.forEach(d=>{
      if(d.mode==='PATROL'){
        d.x=d.ring*Math.cos(d.th);
        d.y=d.ring*Math.sin(d.th);
      }
    });
  }

  function updateHUD(){
    const active=app.drones.filter(d=>d.mode!=='GROUND' && d.mode!=='CHARGE').length;
    el.fleetV.textContent = String(app.drones.length);
    el.activeV.textContent = String(active);
    el.timeV.textContent = app.time.toFixed(1)+'s';
    el.incV.textContent = String(app.inc);
  }

  /* ===== Logging ===== */
  const feed=[];
  function logAlert(kind,msg){
    const ts = new Date();
    const stamp = ts.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    feed.unshift({kind,msg,stamp});
    if(feed.length>80) feed.pop();
    renderFeed();
    if(kind==='bad' || kind==='assist') ping(kind==='bad'?'distress':'assist');
    if(kind==='ok') ping('resolve');
  }

  function renderFeed(){
    el.feed.innerHTML = feed.map(item=>
      `<div class="alert ${item.kind}"><div class="ts">${item.stamp}</div><div>${item.msg}</div></div>`
    ).join('');
  }

  /* ===== Fleet UI ===== */
  function renderFleet(){
    el.list.innerHTML = app.drones.map(d=>{
      const pct=Math.round(d.battery);
      const width=Math.max(0, Math.min(100, pct));
      const blink = d.blink>0 ? ' style="outline:1px solid rgba(255,255,255,.4);outline-offset:2px"' : '';
      return `
        <div class="row" data-id="${d.id}"${blink}>
          <div class="id">${d.id}</div>
          <div class="mode">${d.mode}</div>
          <div class="bat"><div class="f" style="right:${100-width}%"></div></div>
          <div class="alt">${d.alt.toFixed(0)}m</div>
          <div class="pct">${pct}%</div>
        </div>`;
    }).join('');
  }

  /* ===== Simulation loop ===== */
  function init(){
    app.drones = Array.from({length:CFG.COUNT}, (_,i)=>createDrone(i));
    app.time = 0; app.run = false; app.inc = 0; app.pendingIncidentAt = null;
    app.assistResolver = null; app.incidentId = null; app.helpers = [];
    feed.length = 0; renderFeed();
    updateHUD();
    renderFleet();
    resize();
    render();
    el.status.textContent = 'Grounded';
    el.status.className = 'status neutral';
  }

  function resize(){
    const rect = el.map.getBoundingClientRect();
    view.dpr = window.devicePixelRatio || 1;
    view.w = Math.round(rect.width * view.dpr);
    view.h = Math.round(rect.width * (10/16) * view.dpr);
    el.map.width = view.w;
    el.map.height = view.h;
    el.map.style.height = rect.width * (10/16) + 'px';
    ctx.setTransform(view.dpr,0,0,view.dpr,0,0);
    render();
  }

  function step(now){
    if(!app.last) app.last = now;
    const dt = Math.min(0.12, (now - app.last) / 1000);
    app.last = now;

    if(app.run){
      app.time += dt;
      updateFleet(dt);
      updateHUD();
      maybeTriggerIncident();
      resolveAssist(dt);
      tickBlink(dt);
      render();
    }

    requestAnimationFrame(step);
  }

  function tickBlink(dt){
    app.drones.forEach(d=>{
      if(d.blink>0){
        d.blink = Math.max(0, d.blink - dt);
      }
    });
  }

  /* ===== Incidents ===== */
  function maybeTriggerIncident(){
    if(app.scenario!=='incident') return;
    if(app.pendingIncidentAt===null){
      app.pendingIncidentAt = app.time + 12 + Math.random()*8;
      return;
    }
    if(app.time >= app.pendingIncidentAt){
      const candidates = app.drones.filter(d=>d.mode==='PATROL');
      if(!candidates.length){
        app.pendingIncidentAt = app.time + 8;
        return;
      }
      const target = candidates[Math.floor(Math.random()*candidates.length)];
      target.mode = 'DISTRESS';
      app.incidentId = target.id;
      target.alt = 0;
      logAlert('bad', `DISTRESS • ${target.id} stalled, requesting assist`);
      requestAssist(target);
      app.pendingIncidentAt = app.time + 20 + Math.random()*10;
      app.inc++;
    }
  }

  function requestAssist(target){
    const helpers = app.drones.filter(d=>d.mode==='PATROL' && d.id!==target.id)
      .sort((a,b)=>Math.hypot(a.x-target.x,a.y-target.y) - Math.hypot(b.x-target.x,b.y-target.y))
      .slice(0,2);
    helpers.forEach((d,i)=>{
      d.mode='ASSIST'; d.assistTargetId=target.id; d.assistRadius = 12 + i*4;
      d.blink = 2.5;
    });
    app.helpers = helpers.map(d=>d.id);
  }

  function resolveAssist(dt){
    if(!app.incidentId) return;
    const target = app.drones.find(d=>d.id===app.incidentId);
    if(!target){ app.incidentId=null; return; }

    if(target.mode==='DISTRESS'){
      target.distressTime = (target.distressTime||0) + dt;
      if(target.distressTime > 9){
        target.mode='PATROL';
        target.distressTime=0;
        logAlert('ok', `RESOLVED • ${target.id} restored to patrol`);
        app.incidentId = null;
        app.helpers.forEach(id=>{
          const h=app.drones.find(d=>d.id===id);
          if(h) h.mode='PATROL';
        });
        app.helpers.length=0;
      }
    }else{
      app.incidentId = null;
      app.helpers.forEach(id=>{
        const h=app.drones.find(d=>d.id===id);
        if(h) h.mode='PATROL';
      });
      app.helpers.length=0;
    }
  }

  /* ===== Commands ===== */
  function handleCommand(cmd){
    const [verb,...rest] = cmd.trim().toLowerCase().split(/\s+/);
    if(!verb) return;
    if(verb==='launch') return doLaunch();
    if(verb==='rtb') return doRTB();
    if(verb==='reset') return doReset();
    if(verb==='assist'){
      const id = rest[0];
      if(!id) return logAlert('bad', 'Invalid assist command (requires drone id)');
      const target=app.drones.find(d=>d.id.toLowerCase()===id.toLowerCase());
      if(!target) return logAlert('bad', `Drone ${id} not found`);
      target.mode='DISTRESS';
      app.incidentId = target.id;
      requestAssist(target);
      logAlert('assist', `Operator flagged ${target.id} for assist`);
      return;
    }
    logAlert('bad', `Unknown command: ${verb}`);
  }

  function doLaunch(){
    if(app.run){ logAlert('bad', 'Fleet already active'); return; }
    app.run = true;
    app.last = performance.now();
    startCleanSweep();
    el.status.textContent = 'Active';
    el.status.className = 'status ok';
    logAlert('ok', 'Fleet launch acknowledged');
  }

  function doRTB(){
    app.drones.forEach(d=>{
      if(d.mode!=='GROUND') d.mode='RTB';
    });
    logAlert('assist', 'Commanded RTB for entire fleet');
  }

  function doReset(){
    init();
    logAlert('ok', 'Panel reset to standby');
  }

  /* ===== Events ===== */
  el.launch.addEventListener('click', () => doLaunch());
  el.rtb.addEventListener('click', () => doRTB());
  el.resetButton.addEventListener('click', () => doReset());
  el.exportBtn.addEventListener('click', () => {
    const blob = new Blob([feed.map(item=>`${item.stamp},${item.kind},${item.msg}`).join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'black-hive-alerts.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  el.cmdSend.addEventListener('click', () => {
    handleCommand(el.cmdIn.value);
    el.cmdIn.value='';
  });
  el.cmdIn.addEventListener('keydown', (e) => {
    if(e.key==='Enter'){
      handleCommand(el.cmdIn.value);
      el.cmdIn.value='';
    }
  });

  document.addEventListener('keydown', (e) => {
    if(e.key==='/'){
      e.preventDefault();
      el.cmdIn.focus();
    }
    if(e.key==='l' || e.key==='L') doLaunch();
    if(e.key==='r' || e.key==='R') doRTB();
    if(e.key==='x' || e.key==='X') doReset();
  });

  el.scenario.addEventListener('change', () => {
    app.scenario = el.scenario.value;
    if(app.scenario!=='incident'){
      app.pendingIncidentAt = null;
      app.incidentId = null;
      app.helpers.length=0;
    }
    logAlert('ok', `Scenario set to ${el.scenario.value}`);
  });

  el.list.addEventListener('click', (e) => {
    const target = e.target.closest('.row');
    if(!target) return;
    const id = target.getAttribute('data-id');
    const drone = app.drones.find(d=>d.id===id);
    if(!drone) return;
    app.highlight = drone.id;
    drone.blink = 2;
    logAlert('assist', `Operator highlighted ${drone.id}`);
  });

  window.addEventListener('resize', resize);

  init();
  requestAnimationFrame(step);
});
</script>
